name: Update Test262 Stats

on:
  schedule:
    - cron: '0 0 * * *' # Daily at midnight UTC
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write

jobs:
  update-stats:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: install
        run: |
          curl -fsSL https://cli.moonbitlang.com/install/unix.sh | bash
          echo "$HOME/.moon/bin" >> $GITHUB_PATH

      - name: Run Test262 suite
        id: run_tests
        # Run tests and capture output, allow failure
        run: |
          moon test --package oboard/tutujs/test --target wasm > test_output.txt 2>&1 || true
          cat test_output.txt # Show output in CI logs

      - name: Calculate Statistics
        id: stats
        run: |
          # Calculate total tests by counting test definitions in .mbt files
          TOTAL_TESTS=$(grep -r "test \"" test/*.mbt | wc -l)
          
          # Calculate failed tests by counting "FAILED: Test failed" in output
          FAILED_TESTS=$(grep "FAILED: Test failed" test_output.txt | wc -l)
          
          # Calculate passed tests
          PASSED_TESTS=$((TOTAL_TESTS - FAILED_TESTS))
          
          echo "Total: $TOTAL_TESTS"
          echo "Failed: $FAILED_TESTS"
          echo "Passed: $PASSED_TESTS"
          
          echo "passed=$PASSED_TESTS" >> $GITHUB_OUTPUT
          echo "total=$TOTAL_TESTS" >> $GITHUB_OUTPUT

      - name: Generate Progress SVG
        run: |
          python3 test/generate_progress_svg.py ${{ steps.stats.outputs.passed }} ${{ steps.stats.outputs.total }} test/test262_progress.svg

      - name: Commit and Push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add test/test262_progress.svg
          git commit -m "chore: update Test262 progress stats [skip ci]" || echo "No changes to commit"
          git push